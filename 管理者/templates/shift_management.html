<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{url_for('static',filename='/css/shift_management.css')}}">
    <title>ã‚·ãƒ•ãƒˆç®¡ç†</title>
    <style>
        table {
        width: 100%;
        border-collapse: collapse;
        }
        th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
        }
        th {
        background-color: #F2F2F2;
        }
    </style>
</head>
<body>
    <header>
        <a href="{{url_for('menu')}}" class="titlename">æ¸…æƒç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </a>
        <p>ãƒ€ã‚¤ãƒ¯ãƒ­ã‚¤ãƒãƒƒãƒˆãƒ›ãƒ†ãƒ«</p>
    </header>

    <h3 class="up">å‡ºå‹¤æ—¥ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦æ›´æ–°ã—ã¦ãã ã•ã„</h3>
    <h3 class="black">å¸Œæœ›ä¼‘ã«ã¯ğŸ”³ãŒè‡ªå‹•ã§å…¥ã‚Šã¾ã™</h3>

    <form action="{{url_for('shift_register')}}", method="post">
        <input type="text" name="emp_id" placeholder="å¾“æ¥­å“¡ID">
        <button type="submit">æ›´æ–°</button>
        <div id="shiftTable"></div>
        <input type="hidden" name="shift_work">
    </form>

    <form action="{{url_for('menu')}}" method="post">
        <button type="submit" class="button2">æˆ»ã‚‹</button>
    </form>
    
    <script>
        const employees = [
            {% for name in name %}
                {ID: "{{name[0]}}", name: "{{name[1]}}", type: "{{name[2]}}"},
            {% endfor %}
        ]
    
        function generateDateRange(startDate, endDate) {
            const dates = [];
            let currentDate = new Date(startDate.getTime());
    
            while (currentDate <= endDate) {
                dates.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dates;
        }
    
        function createShiftTable(employees, dates) {
            const table = document.createElement('table');
            table.setAttribute('border', '0'); // ãƒ†ãƒ¼ãƒ–ãƒ«ã® border ã‚’ 0 ã«è¨­å®š
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            table.appendChild(thead);
            table.appendChild(tbody);
    
            const headerRow = document.createElement('tr');
            const yearMonthCell = document.createElement('th');
            yearMonthCell.textContent = `${dates[0].getFullYear()}-${String(dates[0].getMonth() + 1).padStart(2, '0')}`;
            headerRow.appendChild(yearMonthCell);
    
            dates.forEach(date => {
                const th = document.createElement('th');
                th.textContent = String(date.getDate()).padStart(2, '0');
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
    
            const selectedDates = []; // é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã‚’ä¿æŒã™ã‚‹ãƒªã‚¹ãƒˆ

            employees.forEach(employee => {
                const row = document.createElement('tr');
                const nameCell = document.createElement('td');
                const employeeName = employee.name.split(" ")[0];

                nameCell.textContent = `${employee.name} (${employee.type})`;
                nameCell.setAttribute('name', 'name');
                nameCell.setAttribute('value', employeeName);

                row.appendChild(nameCell);

                dates.forEach(date => {
                    const cell = document.createElement('td');
                    const isCurrentMonth = date.getMonth() === dates[0].getMonth() && date.getFullYear() === dates[0].getFullYear();
        
                    if (isCurrentMonth) {
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                        checkbox.value = dateString;
        
                        checkbox.addEventListener('change', function() {
                            if (checkbox.checked) {
                                checkbox.parentElement.style.backgroundColor = 'lightgreen';
                                const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                                selectedDates.push(dateString); // æ—¥ä»˜ã‚’æ–‡å­—åˆ—ã«å¤‰æ›ã—ã¦ãƒªã‚¹ãƒˆã«è¿½åŠ 
                            } else {
                                checkbox.parentElement.style.backgroundColor = '';
                                const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                                const index = selectedDates.indexOf(dateString);
                                if (index !== -1) {
                                    selectedDates.splice(index, 1); // ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                                }
                            }
                            console.log(selectedDates);
                        });
        
                        cell.appendChild(checkbox);
                    } else {
                        cell.textContent = '';
                        cell.style.display = 'none';
                    }
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });
        
            // createShiftTableé–¢æ•°å†…
            const shiftWorkInput = document.querySelector('input[name="shift_work"]');

            const form = document.querySelector('form');
            form.addEventListener('submit', function(event) {
                event.preventDefault(); // ãƒ•ã‚©ãƒ¼ãƒ ã®é€šå¸¸ã®é€ä¿¡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                
                shiftWorkInput.value = selectedDates.join(','); // æ—¥ä»˜ãƒªã‚¹ãƒˆã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®æ–‡å­—åˆ—ã«å¤‰æ›ã—ã¦éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
                form.submit(); // ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡
            });

            document.getElementById('shiftTable').appendChild(table);
        }
    
        const today = new Date();
        const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1); // æ¬¡ã®æœˆã®æœ€åˆã®æ—¥ã‚’å–å¾—
        const startDate = new Date(nextMonth.getFullYear(), nextMonth.getMonth(), 1);
        const endDate = new Date(nextMonth.getFullYear(), nextMonth.getMonth() + 1, 0);
        const dateRange = generateDateRange(startDate, endDate);

        createShiftTable(employees, dateRange);
    </script>

</body>
</html>